@startuml

actor client as c
participant service as s
participant tinterceptor as ti
participant tstack as ts
participant transactionInfo as tif
participant emdelegate as emd
participant tm
participant em
participant pfactory as pf
participant query1 as q1
participant query2 as q2

c -> s: call
activate s
s -> ti: intercept
activate ti
ti -> ts: new stackentry(attribute)
create tif
ts -> tif: new
ti -> tm: begin
tm --> ti: ok
ti -> s: invoke
activate s
s -> emd: createQuery
activate emd
emd -> pf: getEmTransactional
pf -> ts: searchEm(pf)
activate ts
ts --> pf: not found
deactivate ts
create em
pf -> em: new
pf -> ts: takePart(em)
activate ts
ts -> tif: register(em)
tif -> em: joinTransaction
ts --> pf: ok
deactivate ts
pf --> emd: em
emd -> em: createQuery
create q1
em -> q1: createQuery
em --> emd: q1
emd --> s: q1
deactivate emd
s -> q1: execute
activate q1
q1 --> s: results
deactivate q1
destroy q1
s -> emd: createQuery
activate emd
emd -> pf: getEmTransactional
pf -> ts: searchEm(pf)
activate ts
ts --> pf: em
deactivate ts
pf --> emd: em
emd -> em: createQuery
create q2
em -> q2: createQuery
em --> emd: q2
emd --> s: q2
deactivate emd
s -> q2: execute
activate q2
q2 --> s: results
deactivate q2
destroy q2
s --> ti: return
deactivate s
activate ti
ti -> tm: commit
tm -> em: flush
em --> tm: ok
tm --> ti: ok
ti -> ts: close
activate ts
ts -> em: close
em --> ts: ok
destroy em
ts --> tif: close
destroy tif
ts --> ti: ok
deactivate ts
deactivate ti
ti --> s: return from intercept
deactivate ti
s --> c: return
deactivate s
@enduml
